<%
	const logo_32 = '/images/logo_32.png';
	const logo_48 = '/images/logo_48.png';
	const logo_64 = '/images/logo_64.png';
	const logo_96 = '/images/logo_96.png';
	const logo_128 = '/images/logo_128.png';
	const logo_144 = '/images/logo_144.png';
	const logo_192 = '/images/logo_192.png';
	const logo_1024 = '/images/logo_1024.png';
	const logo = logo_64;
	const mask_icon = '';
%>

<!DOCTYPE html>
<html>
<head>
	<%# meta:language %>
	<meta http-equiv="content-language" content="en">
	<%# meta:charset %>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta charset="utf-8">
	<%# meta:viewport %>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<%# link:icons %>
	<link rel="apple-touch-icon" sizes="192x192" href="<%= logo_192 %>">
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	<link rel="icon" type="image/png" sizes="32x32" href="<%= logo_32 %>">
	<!-- <link rel="mask-icon" href="<%= mask_icon %>" color="#121212"> -->
	<!-- <link rel="manifest" href="/assets/manifest.webmanifest"> -->
	<meta name="theme-color" content="#121212">





	<%#meta name="viewport" content="width=1040"%>
	<%#meta name="MobileOptimized" content="1040"%>

	<!-- <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" > -->
	<!-- <link rel="icon" href="<%= logo_32 %>" sizes="32x32"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_32 %>" sizes="32x32"> -->
	<!-- <link rel="icon" href="<%= logo_48 %>" sizes="48x48"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_48 %>" sizes="48x48"> -->
	<!-- <link rel="icon" href="<%= logo_64 %>" sizes="64x64"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_64 %>" sizes="64x64"> -->
	<!-- <link rel="icon" href="<%= logo_96 %>" sizes="96x96"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_96 %>" sizes="96x96"> -->
	<!-- <link rel="icon" href="<%= logo_128 %>" sizes="128x128"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_128 %>" sizes="128x128"> -->
	<!-- <link rel="icon" href="<%= logo_144 %>" sizes="144x144"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_144 %>" sizes="144x144"> -->
	<!-- <link rel="icon" href="<%= logo_192 %>" sizes="192x192"> -->
	<!-- <link rel="apple-touch-icon" href="<%= logo_192 %>" sizes="192x192"> -->

	
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	
	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:100,300" rel="stylesheet">


	<title><%= options.env !== 'prod' ? ('[' + options.env + '] ') : '' %>Comics Time</title>
	<%# jQuery %>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<%# select2 %>
	
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.full.js"></script>
	<%# EJS %>
	<script src="/js/ejs.js"></script>
	<%# custom %>
	
	<link rel="stylesheet" type="text/css" href="/css/main.css" />

	<%# dev only %>
	
	<link href="/css/prism.css" rel="stylesheet" />
	<style>
		code[class*="language-"], pre[class*="language-"] {
			font-size: 12px;
			white-space: normal;
			word-break: break-word;
			max-height: 500px;
		}
	</style>

	<script src="https://kit.fontawesome.com/e581184fd2.js" crossorigin="anonymous"></script>

	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto|Montserrat:black">


	<!--script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js" integrity="sha256-H9jAz//QLkDOy/nzE9G4aYijQtkLt9FvGmdUTwBk6gs=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/fr.js" integrity="sha256-D0tqyrTQHDExvGYoi+kyInjV47fm30M5qq4whUrMuuE=" crossorigin="anonymous"></script-->
</head>
<body id="container" class="<%= options.env !== 'prod' ? ('env__' + options.env) : '' %>">
	<div id="main">



		<div class="page-left page-sidebar">

			<a href="#" class="extend-left-link"><i class="fa fa-bars"></i></a>

			<div class="scrollable scrolling-element">
				<div class="wrapper">
					<a id="home-link" href="/"> <%# height: 66px; %>
						<img class="logo" src="<%= logo %>" alt="COMICS TIME"> <span id="home-text">Comics Time</span>
					</a>

					<div class="" id="search-wrap">
						<%# search %>
						<select id="search" name="search"></select>
						<%# // search %>
					</div>

					<section id="menu">
						<ul class="menu list-unstyled">

							<li class="calendar">
								<a href="/calendar" title="Calendar">
									<i class="fas fa-calendar icon-tvst-calendar-alt">
										<span class="calendar-day"><%= ("0" + new Date().getDate()).slice(-2) %></span>
									</i>
									<span class="menu-title">Calendar</span>
								</a>
							</li>

							<li class="list">
								<a href="/list" id="list" title="All comics">
									<i class="fas fa-list icon-tvst-calendar-alt"></i>
									<span class="menu-title">All comics</span>
								</a>
							</li>

							<li class="history">
								<a href="/history" id="history" title="history">
									<i class="fas fa-history icon-tvst-calendar-alt"></i>
									<span class="menu-title">History</span>
								</a>
							</li>

							<li class="tests">
								<a href="#update" id="update" title="Update">
									<i class="fa fa-sync-alt icon-tvst-calendar-alt"></i>
									<span class="menu-title">Update</span>
								</a>
							</li>

							<li class="backup">
								<a href="/backup" id="backup" title="backup" download="comics_<%= new Date().getFullYear() + '' + ("0" + (new Date().getMonth() + 1)).slice(-2) + '' + ("0" + new Date().getDate()).slice(-2) %>.json">
									<i class="fa fa-download icon-tvst-calendar-alt"></i>
									<span class="menu-title">Backup</span>
								</a>
							</li>
						</ul>
					</section>

					<!--div class="nav-bottom">
						<a href="#settings" class="settings-link" title="Settings">
							<i class="fa fa-cog settings-cog"></i>
						</a>
					</div-->


				</div>
			</div>

			<!-- -->
			<!-- -->
			<!-- -->
			<!-- -->


			<%# update %>
			<button id="update" name="update" style="display:none">update</button>
			<%# // update %>

			

			%>
		</div>



		<div class="page-center">
			<div id="<%= options.main %>">

			<% switch(options.page) {
				default: break;
				%>

				<%# HOMEPAGE %>
				<% case "homepage":

					comics_to_read = comics.filter(c => {
						return c.to_read && (parseInt(c.to_read.issue_number) > 1 || c.started);
					}).sort((a, b) => { return new Date(b.date.updated) - new Date(a.date.updated); })
					comics_not_started = comics.filter(c => {
						return c.to_read && parseInt(c.to_read.issue_number) <= 1 && !c.started;
					}).sort((a, b) => { return new Date(b.date.updated) - new Date(a.date.updated); })
					comics_done = comics.filter(c => {
						return !c.to_read;
					}).sort((a, b) => { return new Date(b.date.updated) - new Date(a.date.updated); })
				%>
					<section class="to-read" id="to-read">
						<h1>Read next&nbsp;(<span class="nb-items"><%= comics_to_read.length %></span>)</h1>
						<ul class="to-read-list covers-list list-unstyled list-inline single-row">
							<%
							comics_to_read.forEach( comic => { %>
								<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
							<% }); %>
						</ul>
					</section>
					<% if (comics_not_started) { %>
						<section class="to-read" id="not-started">
							<h1>Not started yet&nbsp;(<span class="nb-items"><%= comics_not_started.length %></span>)</h1>
							<ul class="to-read-list covers-list list-unstyled list-inline single-row">
								<% comics_not_started.forEach( comic => { %>
									<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
								<% }); %>
							</ul>
						</section>
					<% } %>
					<% if (comics_done) { %>
						<section class="to-read" id="done">
							<h1>Up to date&nbsp;(<span class="nb-items"><%= comics_done.length %></span>)</h1>
							<ul class="to-read-list covers-list list-unstyled list-inline single-row">
								<% comics_done.forEach( comic => { %>
									<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
								<% }); %>
							</ul>
						</section>
					<% } %>
					<% break %>

				<%# COMICS %>
				<% case "comics": %>

					<section class="to-read" id="comics-list">
						<h1><%= comic.name %> (<%= comic.start_year %>)</h1>

						<% comic.issues.sort((a, b) =>	(parseFloat(a.issue_number.replace('.HU', '.5')) > parseFloat(b.issue_number.replace('.HU', '.5'))) ? 1 : -1); %>
						<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
					</section>
					<% break %>

				<%# CALENDAR %>
				<% case "calendar": 

					// var calendar_days = Object.keys(calendar).reverse();
					var min_date = options.calendar.params.min;//calendar_days[calendar_days.length - 1];
					var max_date = options.calendar.params.max;//calendar_days[0];
				%>

					<section class="to-read" id="comics-calendar">

						<div class="ordering">
							<a href="#" class="calendar-direction" id="calendar-newer" 
								data-direction="bottom" 
								data-max-date="<%= max_date%>"
								title="Newer">
								<span class="menu-title">↓ newer</span>
							</a>

							<a href="#" class="calendar-direction" id="calendar-older" 
								data-direction="top" 
								data-min-date="<%= min_date%>"
								title="Older">
								<span class="menu-title">↑ older</span>
							</a>
						</div>
						
						<h1>Calendar</h1>

						<div class="calendar-wrapper" id="issues_list">

							<% Object.entries(calendar).sort().forEach(([date, items]) => { %>
								<%- include('includes/calendar.ejs', {options: options, date: new Date(date), items: items}); %>
							<% }); %>

							<script>
								// console.log('min_date:', '<%= min_date %>');
								// console.log('max_date:', '<%= max_date %>');
								// console.log(Object.keys(<%- JSON.stringify((calendar)) %>)[0]);
								// console.log(<%- JSON.stringify((calendar)) %>);
								// var calendar_displayed_issues = <%- JSON.stringify(Object.entries(calendar).map(i => i.id )) %>;
							</script>
						</div>

						<input type="hidden" id="calendar-end-date" name="calendar-end-date" value="<%= Object.keys(calendar)[0] %>" />
					</section>
					<% break %>

				<%# LIST %>
				<% case "list":
					// comic.issues.filter(i => !i.read).length

					// getting done and still actived comics
					comics_done_actived = comics.filter(c => c.active && !c.issues.filter(i => !i.read).length);
					comics_done_actived_ids = comics_done_actived.map(c => c.id);
					//console.log();
				%>

					<section class="to-read" id="comics-list">
						<% comics_enabled = comics.filter(c => c.active) %>
						<h1>All comics&nbsp;(<span class="nb-items" id="list-nb-items"><%= comics_enabled.length %></span>/<%= comics.length %>)</h1>


						<% if (comics_done_actived.length) { %>
							<h2>Finished Comics &nbsp;(<span class="nb-items-finished"><%= comics_done_actived.length %>)</h2>
							<%
							// sorting by name
							comics_done_actived.sort((a, b) => {
								if(a.name < b.name) { return -1; }
								if(a.name > b.name) { return 1; }
								return 0;
							})
							comics_done_actived.forEach( comic => {%>
								<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
							<% }); %>
							<hr/>
						<% } %>


						<%
						// sorting by name
						comics.sort((a, b) => {
							if(a.name < b.name) { return -1; }
							if(a.name > b.name) { return 1; }
							return 0;
						})
						comics.forEach( comic => { 
							if (comics_done_actived_ids.includes(comic.id)) {
								console.log(comic.id)
								return;
							} %>
							<%- include('includes/comic.ejs', {options: options, comic: comic}) %>
						<% }); %>
					</section>
					<% break %>

				<%# HISTORY %>
				<% case "history": %>

					<section class="to-read" id="comics-history">

						<div class="ordering">
							<a href="#" id="history-older" title="Older">
								<span class="menu-title">↑ older</span>
							</a>
						</div>
						
						<h1>History</h1>

						<div id="issues_list">
							<% issues.forEach(i => { %>
								<%- include('includes/issue.ejs', {
									issue: i,
									comic: {
										link: i.comics_link,
										id: i.comics_id,
										name: i.comics,
										start_year: i.comics_start_year,
									},
									options: {
										page: 'history'
									}
								}) %>
							<% }) %>
							<script>
								var history_displayed_issues = <%- JSON.stringify(issues.map(i => i.id )) %>;
							</script>
						</div>

						<input type="hidden" id="history-end-date" name="history-end-date" value="<%= end_date %>" />
					</section>
					<% break %>

				<div id="test"></div>

			<% } %>
			</div>
		</div>



	</div>


	<script>
		var options = <%- JSON.stringify(options) %>;
		
		<%#
	options.calendar = {
		min: {
			date: date_start,
			more: true
		},
		max: {
			date: date_end,
			more: true
		}
	}
		%>
	</script>
	<script src="/js/main.js"></script>
	<%# addons %>
	<script src="/js/addons.js"></script>
	<%# dev only %>
	<script src="/js/prism.js"></script>

	<style>
		/*
background: url(https://comicvine.gamespot.com/api/image/scale_small/4852083-01.jpg) 50% 50%;
	filter: blur(10px);
		*/
	</style>

	<script>
		$(document).on('click', '.comics-issue-top:not(.comics-issue-status *)', function(e) {
			// prevent
			if (e.target.closest('.comics-issue-status')) {
				return false;
			}
			$(this).closest('.comics-issue').toggleClass('open');
		});
	</script>
</body>
</html>
<%# ul.SEARCH search-results-list shows-results-list covers-list list-unstyled list-inline %>